<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能力倾向测试</title>
    
    <style>
        /* --- 全局和问卷基础样式 --- */
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background-color: #f4f7f6; 
            color: #333;
            padding: 20px;
            /* 消除移动端点击时的瞬时高亮效果 */
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* --- 视图 1: 用户名输入界面样式 --- */
        .start-box {
            max-width: 450px;
            margin: 100px auto;
            padding: 40px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .start-box h1 {
            color: #6C63FF;
            font-size: 2em;
            margin-bottom: 20px;
        }
        .start-box p {
            color: #777;
            margin-bottom: 30px;
        }
        .start-box input[type="text"] {
            width: 80%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1.1em;
            text-align: center;
        }
        #start-button {
            background-color: #6C63FF;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #start-button:hover {
            background-color: #574BDB;
        }

        /* --- 视图 2: 问卷基础样式 (原 .question-box) --- */
        .question-box {
            max-width: 700px;
            margin: 50px auto;
            padding: 40px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            /* 禁止问卷框内的所有文本和元素被选中，消除光标/选区 */
            user-select: none; 
        }
        h3 {
            font-size: 1.8em;
            margin-bottom: 40px;
            color: #4A4A4A;
        }
        
        /* --- 进度条样式 --- */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 30px;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%; 
            background-color: #6C63FF;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* --- 5. 圆圈选项样式 --- */
        .options-container {
            display: flex;
            flex-direction: row; 
            justify-content: space-between; 
            align-items: center;
            padding: 0 20px;
            margin: 40px auto;
        }
        
        .option-circle {
            width: 40px; 
            height: 40px;
            border-radius: 50%; 
            border: 3px solid #ccc;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none; 
            outline: none;
        }

        /* 鼠标悬停效果 */
        .option-circle:hover {
            border-color: #6C63FF; 
            transform: scale(1.1);
        }
        
        /* 选中状态 (点击后) */
        .option-circle.active {
            border-color: #6C63FF;
            background-color: #6C63FF;
            box-shadow: 0 0 0 5px rgba(108, 99, 255, 0.3);
            transform: scale(1.1);
        }

        /* 消除圆圈被按下时的闪烁 */
        .option-circle:active {
            transform: scale(1.05); 
        }
        
        /* --- 选项文字描述定位 --- */
        .label-positions-container {
            display: flex;
            justify-content: space-between; 
            width: 100%; 
            padding: 0 20px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #777;
        }

        .label-positions-container span {
            text-align: center;
            flex-basis: 33.33%; 
        }

        .label-positions-container .label-left {
            text-align: left;
            transform: translateX(-13px); 
        }

        .label-positions-container .label-center {
            transform: translateX(-20px); 
        }

        .label-positions-container .label-right {
            text-align: right;
            transform: translateX(-33px); 
        }
        
        /* --- 按钮样式 --- */
        #next-button {
            background-color: #6C63FF;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.1s ease;
            margin-top: 50px;
        }
        #next-button:hover {
            background-color: #574BDB;
        }
        #next-button:active {
            background-color: #574BDB; 
            transform: translateY(1px);
        }
    </style>
</head>
<body>

    <div id="start-view" class="start-box">
        <h1>欢迎参加能力倾向测试</h1>
        <p>请留下您的名称，然后点击开始。</p>
        
        <input type="text" id="username-input" placeholder="请输入您的名称" maxlength="15">
        
        <button id="start-button">开始测试</button>
    </div>

    <div id="quiz-view" class="question-box" style="display: none;">
        <div id="progress-bar-container" class="progress-bar">
            <div id="progress-fill" class="progress-bar-fill" style="width: 0%;"></div> 
        </div>
        
        <p id="question-counter">第 1 题 / 共 50 题</p> 
        
        <h3 id="question-text">问题内容将被加载到这里。</h3> 
        
        <div id="options-container" class="options-container">
            <div class="option-circle" data-value="-2" title="完全不同意"></div>
            <div class="option-circle" data-value="-1" title="有点不同意"></div>
            <div class="option-circle" data-value="0" title="中立"></div>
            <div class="option-circle" data-value="1" title="有点同意"></div>
            <div class="option-circle" data-value="2" title="完全同意"></div>
        </div>
        
        <div class="label-positions-container">
            <span class="label-left">完全不同意</span>
            <span class="label-center">中立</span>
            <span class="label-right">完全同意</span>
        </div>
        
        <button id="next-button">下一题</button>
    </div>

    <script src="questions.js"></script> 

    <script>
			// ----------------------------------------------------
			// 1. 导入数据和常量
			// ----------------------------------------------------
			// ⚠️ 假设 questions.js 和 test.html 位于同级目录
			// ⚠️ 如果您使用 ES6 模块，请将以下 require 语句替换为 import
			// 示例：const questions = require('./questions').default;
			// 由于无法直接 require，我将代码结构改为假设您已将 questions.js 内容复制到此文件或使用模块导入。
			
			// 为了让代码能运行，您需要确保 questions 数组和 SCALES_ORDER 常量在此处可用。
			// 如果您保留了单独的 questions.js 文件，请将该文件内容复制到这里来运行。

			const SCALES_ORDER = [
				'Ne', 'Ni', 'Se', 'Si', 'Fe', 'Fi', 'Te', 'Ti',
				'学习动机', '学习方式', '信息处理', '思维', '情绪', '社交沟通', '自我管理', '创造'
			];
			
			// 定义 16 个维度的初始值
			const SCALES_TEMPLATE = SCALES_ORDER.reduce((acc, scale) => {
				acc[scale] = 0;
				return acc;
			}, {});
			
			const TOTAL_PRACTICAL_QUESTIONS = 64; 
			const MAX_ANSWER_SCORE = 5; // 单个问题的最高分

			// ----------------------------------------------------
			// 2. DOM 元素和状态
			// ----------------------------------------------------
			const startView = document.getElementById('startView');
			const quizView = document.getElementById('quizView');
			const usernameInput = document.getElementById('username');
			const startButton = document.getElementById('startButton');
			const questionTextElement = document.getElementById('questionText');
			const progressText = document.getElementById('progressText');
			const progressFilled = document.getElementById('progressFilled');
			const circles = document.querySelectorAll('.answer-circle');
			const nextButton = document.getElementById('nextButton');

			let currentQuestionIndex = 0;
			let userAnswers = []; // 存储 { id: questionId, value: score }
			let username = '';
			
			// ----------------------------------------------------
			// 3. 核心功能函数
			// ----------------------------------------------------

			// A. 渲染问题
			function renderQuestion(index) {
				// 确保 questions 数组已经被正确加载
				if (!window.questions || index >= questions.length) {
					console.error("Questions array not loaded or index out of bounds.");
					return;
				}

				const question = questions[index];
				questionTextElement.textContent = `${index + 1}. ${question.text}`;

				// 清除上一个问题的选中状态
				circles.forEach(c => c.classList.remove('active'));
				nextButton.disabled = true;

				// 更新进度条和文本
				progressText.textContent = `第 ${index + 1} 题 / ${questions.length} 题`;
				const percentage = ((index + 1) / questions.length) * 100;
				progressFilled.style.width = `${percentage}%`;

				// 尝试恢复答案
				const existingAnswer = userAnswers.find(a => a.id === question.id);
				if (existingAnswer) {
					const selectedCircle = document.querySelector(`.answer-circle[data-score="${existingAnswer.value}"]`);
					if (selectedCircle) {
						selectedCircle.classList.add('active');
						nextButton.disabled = false;
					}
				}
			}

			// B. 计分逻辑
			function calculateScores() {
				let results = { ...SCALES_TEMPLATE }; // 从模板开始
				const MAX_SCORE = MAX_ANSWER_SCORE;

				// Helper 函数：计算最终分数 (处理反向计分)
				const getFinalScore = (direction, rawScore) => {
					if (direction === -1) {
						// 反向计分: 1 -> 5, 2 -> 4, ..., 5 -> 1
						return (MAX_SCORE + 1) - rawScore;
					}
					return rawScore; // 正向计分
				};

				userAnswers.forEach(answer => {
					const question = questions.find(q => q.id === answer.id);
					const score = answer.value;

					if (!question || question.type === 'filler') {
						return; // 忽略填充问题
					}

					// 1. 荣格八维 (功能) 计分
					if (question.func_scale && question.func_direction !== 0) {
						const finalScore = getFinalScore(question.func_direction, score);
						results[question.func_scale] += finalScore;
					}

					// 2. 人格可发展领域 (领域) 计分
					if (question.dev_scale && question.dev_direction !== 0) {
						const finalScore = getFinalScore(question.dev_direction, score);
						results[question.dev_scale] += finalScore;
					}
				});
				
				// --- 最终数据准备：标准化分数 ---
				
				let finalNormalizedScores = {};
				
				SCALES_ORDER.forEach(scaleName => {
					const rawScore = results[scaleName];
					
					// ⚠️ 关键：计算每个维度的最大可能得分
					// 您需要根据每个维度实际关联的问题数量来精确计算
					// 简单示例: 假设每个维度平均关联 8 个实用问题 (8 * 5 = 40 分)
					const assumedMaxScoreForScale = 40; 
					
					// 转换为 0.0 到 10.0 的范围 (四舍五入到一位小数)
					const normalizedScore = (rawScore / assumedMaxScoreForScale) * 10;
					finalNormalizedScores[scaleName] = parseFloat(normalizedScore.toFixed(1));
				});
				
				return finalNormalizedScores; // 返回包含 16 个标准化分数 (例如 0.0 - 10.0) 的对象
			}

			// C. 发送数据到 Netlify Function
			async function sendDataToServer(username, finalScores) {
				const BACKEND_SAVE_URL = '/.netlify/functions/save_data';

				const dataToSend = {
					username: username,
					scores: finalScores // 包含 16 个维度分数的对象
				};
				
				try {
					const response = await fetch(BACKEND_SAVE_URL, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(dataToSend),
					});

					if (!response.ok) {
						const errorData = await response.json();
						console.error('Backend save failed:', errorData);
						alert('数据保存失败，请联系管理员。错误详情已打印到控制台。');
						return false;
					}
					console.log('Results successfully saved to Google Sheets.');
					return true;
				} catch (error) {
					console.error('Network or Function Error:', error);
					alert('网络或服务器错误，数据保存失败。');
					return false;
				}
			}

			// D. 显示结果（并发送数据）
			async function showResults() {
				const finalScores = calculateScores(); // 获取 16 个标准化分数

				// 存储分数和用户名，用于结果页显示
				localStorage.setItem('quizResults', JSON.stringify(finalScores)); 
				localStorage.setItem('quizUsername', username);
				
				// 关键：发送数据到后端
				const saveSuccess = await sendDataToServer(username, finalScores);
				
				if (saveSuccess) {
					// 如果数据保存成功，则跳转到结果页
					window.location.href = 'results.html';
				} else {
					// 如果保存失败，可以在此处选择是否仍跳转或停留
					// 为了安全，如果保存失败，最好停留并提示用户重试
				}
			}


			// ----------------------------------------------------
			// 4. 事件监听器
			// ----------------------------------------------------

			// 开始按钮：切换视图并渲染第一个问题
			startButton.addEventListener('click', function() {
				// 验证用户名
				username = usernameInput.value.trim();
				if (username.length < 2) {
					alert('用户名至少需要两个字符。');
					return;
				}

				// 存储用户名
				localStorage.setItem('quizUsername', username);

				startView.style.display = 'none';
				quizView.style.display = 'block';

				// ⚠️ 确保 questions 数组在此处已加载 (如果使用模块导入，需要调整结构)
				if (typeof questions === 'undefined' || questions.length === 0) {
					alert('问题数据未加载，请检查 questions.js 文件。');
					return;
				}
				renderQuestion(currentQuestionIndex);
			});

			// 答案选择：选中圆圈并启用下一题按钮
			circles.forEach((circle) => {
				circle.addEventListener('click', function() {
					circles.forEach(c => c.classList.remove('active'));
					circle.classList.add('active');
					nextButton.disabled = false;
				});
			});

			// 下一题按钮：保存答案并前进
			nextButton.addEventListener('click', function() {
				const selectedCircle = document.querySelector('.answer-circle.active');
				if (!selectedCircle) {
					alert('请选择一个答案。');
					return;
				}

				const score = parseInt(selectedCircle.getAttribute('data-score'));
				const questionId = questions[currentQuestionIndex].id;

				// 存储答案：如果已存在则更新，否则添加
				const existingIndex = userAnswers.findIndex(a => a.id === questionId);
				if (existingIndex !== -1) {
					userAnswers[existingIndex].value = score;
				} else {
					userAnswers.push({ id: questionId, value: score });
				}

				currentQuestionIndex++;

				if (currentQuestionIndex < questions.length) {
					renderQuestion(currentQuestionIndex);
				} else {
					showResults(); // 问卷结束，显示结果并发送数据
				}
			});

			// 键盘快捷键监听
			document.addEventListener('keydown', function(event) {
				if (quizView.style.display !== 'none') {
					const key = event.key;

					if (key === 'Enter') {
						event.preventDefault(); // 阻止默认的 Enter 行为
						nextButton.click();
					} else {
						const selectedIndex = parseInt(key);
						if (selectedIndex >= 1 && selectedIndex <= 5) {
							event.preventDefault(); // 阻止默认的数字键行为
							const targetCircle = circles[selectedIndex - 1];
							if (targetCircle) {
								circles.forEach(c => c.classList.remove('active'));
								targetCircle.classList.add('active');
								nextButton.disabled = false;
							}
						}
					}
				}
			});

			// ----------------------------------------------------
			// 5. 首次加载时检查状态
			// ----------------------------------------------------
			function initApp() {
				const storedUsername = localStorage.getItem('quizUsername');
				
				// 恢复之前输入的用户名
				if (storedUsername) {
					username = storedUsername; 
					usernameInput.value = storedUsername;
				}
				
				// 如果您希望用户返回 test.html 时从头开始，请清除 userAnswers
				// userAnswers = []; 
			}

			document.addEventListener('DOMContentLoaded', initApp);

		</script>
</body>
</html>